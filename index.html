<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NK Classes</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GOOGLE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    :root{
      --blue-light:#9EE9FF;--blue-main:#1976F2;--blue-accent:#0EA5E9;--blue-dark:#07203A;
      --blue-gradient:linear-gradient(135deg,var(--blue-accent),var(--blue-main));
    }
    body{font-family:Inter,system-ui,sans-serif;background:linear-gradient(180deg,#f7fbff 0%,#fff 100%);color:#062433;min-height:100vh}
    .nav-link{position:relative;font-weight:600;color:#07365a}
    .nav-link::after{content:"";position:absolute;left:0;bottom:-6px;width:0;height:2px;background:var(--blue-main);transition:width .22s}
    .nav-link:hover::after{width:100%}
    .tab-active{color:#fff !important;background:var(--blue-gradient);border-radius:10px;padding:6px 12px}
    .logo-glow{box-shadow:0 0 18px rgba(25,118,242,.18)}
    footer h2{background:var(--blue-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    nav{border-bottom-color:rgba(7,32,50,.06)}
    .text-muted{color:#5b6b78}
    .mobile-icon{color:#0b3b66}
    .no-tap-highlight{-webkit-tap-highlight-color:rgba(0,0,0,0)}
    .avatar-circle { width:36px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background:#e6eef9; color:#0b3b66; font-weight:700; font-size:14px; text-transform:uppercase; }

    /* Modal visuals */
    .auth-backdrop {
      background: radial-gradient(1200px 600px at 10% 10%, rgba(14,165,233,0.06), transparent 10%),
                  radial-gradient(900px 500px at 90% 90%, rgba(25,118,242,0.06), transparent 10%),
                  rgba(2,6,23,0.45);
      backdrop-filter: blur(6px);
    }
    .auth-card {
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(7,36,58,0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,252,255,0.96));
      max-width: 920px;
      width: calc(100% - 48px);
      display: grid;
      grid-template-columns: 1fr 1fr;
      overflow: hidden;
    }

    .auth-left {
      padding: 36px;
      background: linear-gradient(180deg, rgba(10,102,194,0.06), rgba(10,102,194,0.02));
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:flex-start;
      justify-content:center;
    }
    .auth-left h3 { font-family: 'Playfair Display', serif; font-size:28px; letter-spacing: -0.6px; color:var(--blue-dark); }
    .auth-left p { color:#274659; font-size:14px; line-height:1.45; }

    .auth-right { padding: 28px; display:flex; align-items:center; justify-content:center; }
    .form-inner { width:100%; max-width:420px; }

    .input-lg { width:100%; padding:14px 14px; border:1px solid #e6eef6; border-radius:10px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); font-size:16px }
    .btn-primary { background: linear-gradient(90deg,#0ea5e9,#1976f2); color:white; padding:12px 16px; border-radius:10px; font-weight:700; }
    .btn-ghost { border:1px solid #e6eef6; padding:10px 12px; border-radius:10px; background:white; }

    @media (max-width:900px){
      .auth-card { grid-template-columns: 1fr; width: calc(100% - 32px); }
      .auth-left { padding: 22px; text-align:center; align-items:center }
      .auth-left h3 { font-size:22px }
      .auth-right { padding: 18px 20px }
    }

    .btn-disabled { opacity:.6; pointer-events:none; }
  </style>
</head>
<body class="text-slate-900">

  <!-- NAVBAR -->
  <nav class="sticky top-0 z-50 bg-white border-b shadow-sm">
    <div class="max-w-6xl mx-auto px-4 md:px-8">
      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-3">
          <img src="favicon.png" class="w-10 h-10 rounded-full shadow-sm object-cover logo-glow" />
          <div class="leading-tight">
            <a class="text-xl font-extrabold" style="font-family:'Playfair Display',serif;background:var(--blue-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">NK Classes</a>
            <div class="text-[11px] text-muted">Where Chemistry Becomes Crystal Clear</div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <!-- restore ALL desktop tabs -->
          <ul id="desktopTabs" class="hidden md:flex gap-3 items-center text-sm">
            <li><button data-route="home" class="nav-link px-2 py-1 rounded-md">Home</button></li>
            <li><button data-route="about" class="nav-link px-2 py-1 rounded-md">About Us</button></li>
            <li><button data-route="materials" class="nav-link px-2 py-1 rounded-md">Study Materials</button></li>
            <li><button data-route="cutoffs" class="nav-link px-2 py-1 rounded-md">Cutoffs</button></li>
            <li><button data-route="placements" class="nav-link px-2 py-1 rounded-md">Placements & Campus</button></li>
            <li><button data-route="contact" class="nav-link px-2 py-1 rounded-md">Contact Us</button></li>
            <li><button data-route="lectures" class="nav-link px-2 py-1 rounded-md">Lectures</button></li>
          </ul>

          <!-- auth area - only Login when logged out -->
          <div id="authArea" class="ml-2 flex items-center gap-3"></div>
        </div>
      </div>

      <!-- MOBILE ICON BAR (restore all icons) -->
      <div class="md:hidden pb-1">
        <div class="grid grid-cols-7 gap-1 items-center text-center px-1 no-tap-highlight">
          <button data-route="home" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9.75L12 3l9 6.75V21a.75.75 0 01-.75.75H3.75A.75.75 0 013 21V9.75z"/></svg><span class="text-[9px] leading-[10px]">Home</span></button>

          <button data-route="about" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5c2.485 0 4.5 2.015 4.5 4.5s-2.015 4.5-4.5 4.5-4.5-2.015-4.5-4.5S9.515 4.5 12 4.5zm0 12c4.142 0 7.5 2.015 7.5 4.5V21H4.5v-.75c0-2.485 3.358-4.5 7.5-4.5z"/></svg><span class="text-[9px] leading-[10px]">About</span></button>

          <button data-route="materials" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6.75V19.5A1.5 1.5 0 004.5 21h12A1.5 1.5 0 0018 19.5V6.75m-15 0L12 3l9 3.75m-15 0l9 3.75 9-3.75"/></svg><span class="text-[9px] leading-[10px]">Materials</span></button>

          <button data-route="cutoffs" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h18M9 3v18m6-18v18M3 12h18"/></svg><span class="text-[9px] leading-[10px]">Cutoffs</span></button>

          <button data-route="placements" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6a9 9 0 100 18 9 9 0 000-18zm0 3v9m4.5-4.5h-9"/></svg><span class="text-[9px] leading-[10px]">Placements</span></button>

          <button data-route="lectures" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/></svg><span class="text-[9px] leading-[10px]">Lectures</span></button>

          <button data-route="contact" class="flex flex-col items-center w-full py-1 mobile-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25v13.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75V5.25zM7.5 9h9m-9 3h9m-9 3h6"/></svg><span class="text-[9px] leading-[10px]">Contact</span></button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN APP -->
  <main id="app" class="max-w-6xl mx-auto px-4 md:px-8 py-8">
    <div class="card p-8">
      <h2 class="text-2xl font-bold mb-2">Welcome to NK Classes</h2>
      <p class="text-sm text-muted">Select a section from the navbar to continue.</p>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="bg-[#042235] text-gray-300 py-10 mt-12">
    <div class="max-w-6xl mx-auto px-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8">
        <div>
          <h2 class="text-2xl font-bold tracking-wide">AAHES</h2>
          <p class="text-sm mt-2 text-gray-300 max-w-md">Empowering Assam’s engineering aspirants with authentic updates, data-driven insights, and resources — all in one trusted platform.</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 md:gap-12 text-sm">
          <div class="group">
            <p class="text-white font-semibold flex items-center gap-2">Abishrant Shandilya</p>
            <p class="text-gray-300 group-hover:text-gray-200 transition">Website Manager</p>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm text-gray-400">© 2025 AAHES. All rights reserved.</div>
    </div>
  </footer>

  <!-- AUTH MODAL (FULLSCREEN BACKDROP, centered non-scroll card) -->
  <div id="authModal" class="fixed inset-0 hidden z-50 flex items-center justify-center auth-backdrop">
    <div class="auth-card mx-4">
      <!-- LEFT: branding -->
      <div class="auth-left">
        <div class="flex items-center gap-3">
          <img src="favicon.png" class="w-12 h-12 rounded-full shadow-sm object-cover" />
          <div>
            <div style="font-family:'Playfair Display',serif" class="text-xl font-bold">NK Classes</div>
            <div class="text-xs text-muted">Where Chemistry Becomes Crystal Clear</div>
          </div>
        </div>

        <h3>Learn. Practice. Conquer.</h3>
        <p>Clear conceptual lessons, concise notes, and specially designed study materials to help you ace your exams & entrance tests.</p>

        <ul class="mt-2 text-sm text-muted space-y-2">
          <li>• Fast revision notes</li>
          <li>• PYQ-based practice</li>
          <li>• Campus & placements data</li>
        </ul>
      </div>

      <!-- RIGHT: forms -->
      <div class="auth-right">
        <div class="form-inner">
          <div class="flex justify-between items-center mb-4">
            <div class="flex gap-2">
              <button id="showLogin" class="px-4 py-2 rounded-md tab-active text-sm">Login</button>
              <button id="showRegister" class="px-4 py-2 rounded-md text-sm">Register</button>
            </div>
            <button id="authClose" class="text-gray-600">✕</button>
          </div>

          <!-- LOGIN FORM -->
          <div id="loginForm">
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Username</label>
              <input id="loginUsername" class="input-lg" placeholder="your username" />
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Password</label>
              <input id="loginPassword" type="password" class="input-lg" placeholder="••••••••" />
            </div>

            <div id="loginError" class="text-sm text-red-500 mb-3 hidden"></div>

            <div class="flex gap-3 mb-4">
              <button id="loginBtn" class="btn-primary flex-1 text-center">Login</button>
              <button id="loginHelp" class="btn-ghost">Need help?</button>
            </div>

            <div class="text-xs text-muted">By logging in you agree to our terms and privacy.</div>
          </div>

          <!-- REGISTER FORM -->
          <div id="registerForm" class="hidden">
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Username</label>
              <input id="regUsername" class="input-lg" placeholder="choose a username" />
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Full name</label>
              <input id="regName" class="input-lg" placeholder="Your full name" />
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Password</label>
              <input id="regPassword" type="password" class="input-lg" placeholder="Minimum 6 characters" />
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Phone (optional)</label>
              <input id="regPhone" class="input-lg" placeholder="+91 98765 43210" />
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Email (recommended)</label>
              <input id="regEmail" type="email" class="input-lg" placeholder="name@example.com" />
            </div>

            <input id="regn" type="text" readonly class="w-full mt-2 mb-3 px-3 py-2 rounded bg-gray-50 text-sm" />

            <div id="regError" class="text-sm text-red-500 mb-3 hidden"></div>

            <div class="flex gap-3 mb-4">
              <button id="registerBtn" class="btn-primary flex-1">Register</button>
              <button id="cancelRegister" class="btn-ghost">Cancel</button>
            </div>

            <div class="text-xs text-muted">We recommend using email so you can recover your account later.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcIHLJdYe_tUA7t4fuapxmyeXXESo4Ze4",
      authDomain: "nk-classes.firebaseapp.com",
      projectId: "nk-classes",
      storageBucket: "nk-classes.firebasestorage.app",
      messagingSenderId: "999944440818",
      appId: "1:999944440818:web:326234d2623f53fa25396b",
      measurementId: "G-56128412GG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // helpers
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
    async function getUserDocByUid(uid){ try{ const doc = await db.collection('users').doc(uid).get(); if(!doc.exists) return null; return {id:doc.id, data: doc.data()}; } catch(e){ console.error(e); return null; } }
    async function findUserDocByUsername(username){ try{ const q = await db.collection('users').where('username','==',username).limit(1).get(); if(!q.empty) return {id:q.docs[0].id, data:q.docs[0].data()}; } catch(e){ console.error(e); } return null; }

    function setModalOpen(open){
      const modal = document.getElementById('authModal');
      if(open){ modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
      else { modal.classList.add('hidden'); document.body.style.overflow = ''; }
    }

    function setLoading(type, on){
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const inputs = Array.from(document.querySelectorAll('#loginForm input, #registerForm input, #loginForm button, #registerForm button, #authTabs button'));
      if(type === 'login'){ if(loginBtn){ loginBtn.dataset.orig = loginBtn.innerHTML; loginBtn.innerHTML = on ? 'Logging in...' : (loginBtn.dataset.orig || 'Login'); } }
      else if(type === 'register'){ if(registerBtn){ registerBtn.dataset.orig = registerBtn.innerHTML; registerBtn.innerHTML = on ? 'Registering...' : (registerBtn.dataset.orig || 'Register'); } }
      inputs.forEach(i => { if(on){ i.classList.add('btn-disabled'); i.setAttribute('disabled','disabled'); } else { i.classList.remove('btn-disabled'); i.removeAttribute('disabled'); } });
    }

    // auth area render
    const authAreaEl = document.getElementById('authArea');
    function renderAuthArea(userDoc){
      if(!authAreaEl) return;
      if(!userDoc){
        authAreaEl.innerHTML = `<button id="navLogin" class="nav-link px-3 py-1 rounded-md">Login</button>`;
        attachNavHandlers();
      } else {
        const username = userDoc.data && userDoc.data.username ? userDoc.data.username : '';
        const name = userDoc.data && userDoc.data.name ? userDoc.data.name : '';
        const initials = (username || name || 'U').charAt(0).toUpperCase();
        authAreaEl.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="avatar-circle" title="${escapeHtml(name || username)}">${escapeHtml(initials)}</div>
            <button id="navLogout" class="px-3 py-1 rounded-md border text-sm">Logout</button>
          </div>`;
        document.getElementById('navLogout')?.addEventListener('click', logout);
      }
    }

    function attachNavHandlers(){
      document.querySelectorAll('[data-route]').forEach(btn=>{
        btn.removeEventListener?.('click', ()=>{});
        btn.addEventListener('click', e=>{
          const route = btn.getAttribute('data-route');
          location.hash = '#/'+route;
          e.preventDefault();
        });
      });
      document.getElementById('navLogin')?.removeEventListener?.('click', ()=>{});
      document.getElementById('navLogin')?.addEventListener('click', ()=> openAuth('login'));
      document.getElementById('mobileLoginBtn')?.addEventListener('click', ()=> openAuth('login'));
    }

    function openAuth(view='login'){
      document.getElementById('loginError')?.classList.add('hidden');
      document.getElementById('regError')?.classList.add('hidden');
      if(view==='login'){
        document.getElementById('loginForm')?.classList.remove('hidden');
        document.getElementById('registerForm')?.classList.add('hidden');
        document.getElementById('showLogin')?.classList.add('tab-active');
        document.getElementById('showRegister')?.classList.remove('tab-active');
      } else {
        document.getElementById('loginForm')?.classList.add('hidden');
        document.getElementById('registerForm')?.classList.remove('hidden');
        document.getElementById('showLogin')?.classList.remove('tab-active');
        document.getElementById('showRegister')?.classList.add('tab-active');
      }
      const regnEl = document.getElementById('regn'); if(regnEl) regnEl.value = new Date().toISOString();
      setModalOpen(true);
    }

    document.getElementById('authClose')?.addEventListener('click', ()=> setModalOpen(false));
    document.getElementById('showLogin')?.addEventListener('click', ()=> openAuth('login'));
    document.getElementById('showRegister')?.addEventListener('click', ()=> openAuth('register'));
    document.getElementById('cancelRegister')?.addEventListener('click', ()=> openAuth('login'));

    // Registration
    document.getElementById('registerBtn')?.addEventListener('click', async () => {
      const username = document.getElementById('regUsername')?.value.trim() || '';
      const name = document.getElementById('regName')?.value.trim() || '';
      const password = document.getElementById('regPassword')?.value || '';
      const phone = document.getElementById('regPhone')?.value.trim() || '';
      const email = document.getElementById('regEmail')?.value.trim() || '';
      const regn = document.getElementById('regn')?.value || new Date().toISOString();
      const errEl = document.getElementById('regError'); if(errEl) errEl.classList.add('hidden');

      if(!username || !name || password.length < 3){
        if(errEl){ errEl.innerText = 'Please enter username, full name and password (>=3 chars).'; errEl.classList.remove('hidden'); }
        return;
      }

      setLoading('register', true);
      try{
        const existing = await findUserDocByUsername(username);
        if(existing){ if(errEl){ errEl.innerText = 'Username already taken.'; errEl.classList.remove('hidden'); } setLoading('register', false); return; }

        let uid = null, firebaseCreated = false;
        if(email){
          try{
            const userCred = await auth.createUserWithEmailAndPassword(email, password);
            uid = userCred.user.uid;
            firebaseCreated = true;
            await userCred.user.updateProfile({ displayName: name }).catch(()=>{});
          } catch(firebaseErr){
            console.warn('Firebase create failed — will fallback to Firestore-only. Error:', firebaseErr);
          }
        }

        const docRefId = uid || db.collection('users').doc().id;
        await db.collection('users').doc(docRefId).set({
          username, name, password, phone: phone || "", email: email || "", paid: "no", regn
        });

        if(!firebaseCreated){
          localStorage.setItem('legacyUser', docRefId);
          const docSnap = await db.collection('users').doc(docRefId).get();
          if(docSnap.exists) renderAuthArea({ id: docSnap.id, data: docSnap.data() });
        }

        setModalOpen(false);
      } catch(e){
        console.error('Registration error', e);
        if(errEl){ errEl.innerText = e.message || 'Registration failed'; errEl.classList.remove('hidden'); }
      } finally { setLoading('register', false); }
    });

    // Login
    document.getElementById('loginBtn')?.addEventListener('click', async () => {
      const username = document.getElementById('loginUsername')?.value.trim() || '';
      const password = document.getElementById('loginPassword')?.value || '';
      const errEl = document.getElementById('loginError'); if(errEl) errEl.classList.add('hidden');

      if(!username || !password){ if(errEl){ errEl.innerText = 'Enter username and password.'; errEl.classList.remove('hidden'); } return; }

      setLoading('login', true);
      try{
        const doc = await findUserDocByUsername(username);
        if(!doc){ if(errEl){ errEl.innerText = 'User not found.'; errEl.classList.remove('hidden'); } setLoading('login', false); return; }

        const email = doc.data.email;
        if(email){
          try{
            await auth.signInWithEmailAndPassword(email, password);
            setModalOpen(false);
            setLoading('login', false);
            return;
          } catch(firebaseErr){
            console.warn('Firebase signIn failed for email', email, firebaseErr);
          }
        }

        if(doc.data && doc.data.password && doc.data.password === password){
          localStorage.setItem('legacyUser', doc.id);
          renderAuthArea(doc);
          setModalOpen(false);
          setLoading('login', false);
          return;
        } else {
          if(errEl){ errEl.innerText = 'Invalid credentials.'; errEl.classList.remove('hidden'); }
        }
      } catch(e){
        console.error('Login error', e);
        if(errEl){ errEl.innerText = 'Login failed. Try again later.'; errEl.classList.remove('hidden'); }
      } finally { setLoading('login', false); }
    });

    async function logout(){
      try{ await auth.signOut(); } catch(e){ console.warn('signOut failed', e); }
      localStorage.removeItem('legacyUser');
      renderAuthArea(null);
    }

    // Monitor firebase state
    auth.onAuthStateChanged(async (user) => {
      try{
        if(user){
          const docData = await getUserDocByUid(user.uid);
          if(!docData){
            await db.collection('users').doc(user.uid).set({
              username: user.email ? user.email.split('@')[0] : user.uid,
              name: user.displayName || '',
              phone: '',
              email: user.email || '',
              paid: "no",
              regn: new Date().toISOString()
            });
            renderAuthArea({ id: user.uid, data: { username: user.email ? user.email.split('@')[0] : user.uid, name: user.displayName || '' } });
          } else renderAuthArea(docData);
          return;
        }
        const legacyId = localStorage.getItem('legacyUser');
        if(legacyId){
          try{
            const doc = await db.collection('users').doc(legacyId).get();
            if(doc.exists){ renderAuthArea({ id: doc.id, data: doc.data() }); return; } else localStorage.removeItem('legacyUser');
          } catch(e){ console.error('legacy read error', e); localStorage.removeItem('legacyUser'); }
        }
        renderAuthArea(null);
      } catch(e){ console.error('onAuthStateChanged error', e); renderAuthArea(null); }
    });

    // router (same mapping as before)
    (function(){
      const app = document.getElementById('app');
      const mapping = {
        home: '/components/home.html',
        about: '/components/about.html',
        materials: '/components/materials.html',
        cutoffs: '/components/cutoffs.html',
        placements: '/components/placements.html',
        contact: '/components/contact.html',
        lectures: '/components/lectures.html'
      };
      function parseHash(){ const h = location.hash || '#/home'; const m = h.match(/^#\/?([^/?#]+)/); return m?m[1]:'home'; }
      async function loadRoute(route){
        const file = mapping[route] || mapping['home'];
        try { const res = await fetch(file,{cache:'no-store'}); if(!res.ok) throw new Error('fetch '+res.status); app.innerHTML = await res.text(); }
        catch(e){ console.warn('failed loading',file,e); try{ const fb = await fetch(mapping['home']); app.innerHTML = await fb.text(); } catch{ app.innerHTML = '<div class="p-6 card"><h2 class="text-xl font-bold">Content unavailable</h2><p class="text-gray-600">Check /components folder.</p></div>'; } }
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('tab-active'));
        document.querySelectorAll(`[data-route="${route}"]`).forEach(btn=> btn.classList.add('tab-active'));
      }
      window.addEventListener('hashchange', ()=> loadRoute(parseHash()));
      document.addEventListener('click', e => { const btn = e.target.closest('[data-route]'); if(!btn) return; const route = btn.getAttribute('data-route'); location.hash = '#/'+route; e.preventDefault(); });
      loadRoute(parseHash());
    })();

    // initial setup once DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{
      if(!document.getElementById('authArea')){ const nav = document.querySelector('nav .max-w-6xl') || document.querySelector('nav'); const wrapper = document.createElement('div'); wrapper.id='authArea'; wrapper.className='ml-2 flex items-center gap-3'; if(nav) nav.appendChild(wrapper); else document.body.prepend(wrapper); }
      // ensure login button shown initially until auth state resolves
      renderAuthArea(null);
      attachNavHandlers();
      document.getElementById('showLogin')?.addEventListener('click', ()=> openAuth('login'));
      document.getElementById('showRegister')?.addEventListener('click', ()=> openAuth('register'));
      document.getElementById('authClose')?.addEventListener('click', ()=> setModalOpen(false));
    });

    window.addEventListener('error', (e)=> console.error('Runtime error:', e.message,'at', e.filename+':'+e.lineno));
  </script>
</body>
</html>
